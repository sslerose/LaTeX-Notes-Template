%%%%%%%%%%%%
% Counters %
%%%%%%%%%%%%

% Declare new {counter} and reset it when [index] increases
\newcounter{mysection}[chapter]
\newcounter{myeqsec}[chapter]
\newcounter{mysubsection}[mysection]
\newcounter{myexample}[chapter]



%%%%%%%%%%%%%%%%%%%%%%
% Chapter Formatting %
%%%%%%%%%%%%%%%%%%%%%%

% Chapter and section markers for fancy header
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{#1}}

% Modification of LaTeX commands to allow for fancy chapter header without damaging commands used by \tableofcontents or \chapter*
\makeatletter   % Allow modification of LaTeX internal commands

\let\originalchapter\chapter    % Save the original chapter command

% Create a new command for custom chapter formatting
\newcommand{\formattedchapter}[1]{%
    \clearpage
    \stepcounter{chapter}
    \chaptermark{#1}
    \thispagestyle{empty}
    
    % Modified TOC entry to ensure proper PDF structure
    \phantomsection  % Add this to ensure proper hyperref linking
    \addcontentsline{toc}{chapter}{\protect\numberline{\thechapter}#1}
    
    \begingroup
    \setlength{\leftskip}{0pt}
    \noindent\bfseries\Huge\thechapter\par\vspace{-12pt}
    \sbox0{\LARGE{\hyperlink{toc}{#1}}}
    \noindent\rule[\dimexpr\ht\strutbox-26pt]{\wd0}{0.4pt}\par
    \noindent\usebox0\par\vspace{6pt}
    \noindent\rule[\dimexpr\ht\strutbox]{\wd0}{0.4pt}
    \endgroup
}

% Store the original \@chapter and \@schapter
\let\old@chapter\@chapter
\let\old@schapter\@schapter

% Redefine the internal chapter commands
\def\@chapter[#1]#2{%
    \ifx\relax#1\relax
        \formattedchapter{#2}%
    \else
        \formattedchapter{#1}%
    \fi
}

\def\@schapter#1{%
    \old@schapter{#1}%
}
\makeatother



%%%%%%%%%%%%%%%%%%%%%%
% Section Formatting %
%%%%%%%%%%%%%%%%%%%%%%

% Create a new command for custom section formatting.
    % Second input used to declare a non-step increase in section numbering (i.e., section 1 declared with \section{Title} followed by section 3 declared with \section[3]{Title}, calling \section again resumes normal step numbering with section 4)
\renewcommand{\section}[2][]{
    \ifx\relax#1\relax
        \refstepcounter{myeqsec}
        \refstepcounter{mysection}
    \else
        \setcounter{mysection}{#1}
        \setcounter{myeqsec}{#1}
    \fi
    \sectionmark{#2}
    \addcontentsline{toc}{section}{\protect\numberline{\themysection}#2}
    
    \setcounter{equation}{0}
    \bigskip
    \begingroup % Begin local group to contain font size/style changes
    \Large
    \setlength{\leftskip}{0pt}
    
    \noindent\textbf{\themysection} % Number aligned with default left margin
    \textbf{#2} % Section title
    
    \endgroup % End local group
    \bigskip
}



%%%%%%%%%%%%%%%%%%%%%%%%%
% Subsection Formatting %
%%%%%%%%%%%%%%%%%%%%%%%%%

% Create a new command for custom subsection formatting.
    % Numbered (using \subsection) or unnumbered (using \subsection*) subsections are possible, neither affect equation number. Unnumbered subsections will not show in TOC, but will show in file outline.
\makeatletter
\def\subsection{
    \@ifstar\@subsection\@@subsection
}

% Unnumbered subsection
\def\@subsection#1{
    \medskip
    \begingroup % Begin local group to contain font size/style changes
    \large
    \setlength{\leftskip}{0pt}
    
    \textbf{#1} % Section title
    
    \endgroup % End local group
    \medskip
}

% Numbered subsection
\def\@@subsection#1{
    \refstepcounter{mysubsection}
    
    \addcontentsline{toc}{subsection}{\protect\numberline{\themysubsection}#1}
    
    \medskip
    \begingroup % Begin local group to contain font size/style changes
    \large
    \setlength{\leftskip}{0pt}
    
    \noindent\textbf{\themysubsection} % Number aligned with default left margin
    \textbf{#1} % Section title
    
    \endgroup % End local group
    \medskip
}
\makeatother



%%%%%%%%%%%%
% Examples %
%%%%%%%%%%%%

% Define environment for writing boxed examples with autonumbering
\mdfdefinestyle{examplestyle}{frametitleaboveskip=\topskip, frametitlebelowskip=\topskip, innermargin=1em, outermargin=1em}

\newenvironment{example}
    {
        \refstepcounter{myexample}  % Increase myexample counter
        \begin{mdframed}[style=examplestyle, frametitle={Example \themyexample:}]    % Create a box around examples that stretches across pages
    }
    {
        \end{mdframed}
    }



%%%%%%%%%%%%%%
% Principles %
%%%%%%%%%%%%%%

% Define environment for displaying boxed sections with gray background to emphasize important topics
\mdfdefinestyle{principlestyle}{linewidth=0pt, frametitlealignment=\centering, frametitleaboveskip=\topskip, frametitlebelowskip=\topskip, frametitlebackgroundcolor=gray!20, backgroundcolor=gray!20, innermargin=1em, outermargin=1em, innerbottommargin=\topskip}

\newenvironment{principle}[1]
    {
        \begin{mdframed}[style=principlestyle, frametitle={#1}]
    }
    {
        \end{mdframed}
    }



%%%%%%%%%%%%%
% Numbering %
%%%%%%%%%%%%%

% Declare various numbering sequences
\renewcommand{\theequation}{\thechapter.\themyeqsec.\arabic{equation}}
\renewcommand{\themysection}{\thechapter-\arabic{mysection}}
\renewcommand{\themysubsection}{\themysection-\arabic{mysubsection}}
\renewcommand{\thefootnote}{\arabic{footnote}}
\renewcommand{\themyexample}{\thechapter.\arabic{myexample}}



%%%%%%%%%%%%%%%%%%%%%%
% Various Formatting %
%%%%%%%%%%%%%%%%%%%%%%

\newcommand*\widefbox[1]{\fbox{\hspace{1em}#1\hspace{1em}}}